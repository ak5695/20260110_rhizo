# 图文联动系统 - 实现路线图

## ✅ 已完成

### 1. 数据库 Schema（100%）
- ✅ Canvas 存储层 (canvases, canvas_elements)
- ✅ 复合节点表结构 (compound_nodes)
- ✅ 文档-画布绑定 (document_canvas_bindings)
- ✅ 变更日志与协作会话表
- ✅ 数据库 ID 兼容性修正（支持 Excalidraw 原生 String ID）

**文件**: `db/canvas-schema.ts`, `db/schema.ts`

### 2. 画布元数据与存储 API（100%）✨
- ✅ **行级增量存储**：支持元素级 CRUD，非大 JSON 覆盖。
- ✅ **原子级 UPSERT**：解决高频自动保存时的数据库主键冲突（Race Condition）。
- ✅ **自动异步保存**：800ms 延迟防抖 + 4s 强制兜底（maxWait），确保数据不丢失。
- ✅ **视口记录与恢复**：自动记忆缩放级别 (Zoom) 和视口位置 (X/Y)。
- ✅ **离场强制冲刷 (Flush)**：组件卸载或页面关闭前强制同步最后一次变更。

**文件**: `actions/canvas.ts`, `components/excalidraw-canvas.tsx`

### 3. 拖拽与选区交互系统（100%）✨ 🎉
- ✅ **统一选区工具栏 (SelectionToolbar)**：集成 AI、画布、概念操作。
- ✅ **自动化交互**：开始拖拽时若画布隐藏，系统自动平滑展开。
- ✅ **多源类型识别**：支持标题、代码块、列表项的差异化样式。
- ✅ **即时预览**：带有渐变色和图标的高级拖拽预览效果。

**文件**: `components/selection-toolbar.tsx`, `lib/canvas/drag-drop-bridge.ts`

### 4. AI 助手与编辑器深度联动（100%）
- ✅ **富文本渲染**：AI 回复支持 Markdown（列表、代码、标题）。
- ✅ **上下文操作**：每条消息下方新增 "Copy" 和 "Insert" 按钮。
- ✅ **智能插入逻辑**：自动将内容解析为 BlockNote 块并插入光标位置后，光标物理追随至末尾。

**文件**: `components/ai-chat-modal.tsx`, `components/editor.tsx`

### 5. 文档-画布双向绑定引擎（100%）✨ 🎉
- ✅ **双向跳转**：点击文档标记直达对应画布节点（Zoom/Center）；点击画布链接直达文档对应 Block。
- ✅ **高性能标记系统**：弃用 Ovelay 方案，改用 CSS 内联样式 + 全局事件委托，实现 0 负载渲染。
- ✅ **深度视觉反馈**：支持实线下划线、背景色高显、鼠标悬浮十字准星。
- ✅ **状态联动 (Ghosting)**：画布节点“删除”或“撤销”时，文档标记自动变为灰色/消失，同步状态。
- ✅ **数据对齐**：通过 SQL Join 查询，实现首屏加载即具备准确的“死/活”状态。

**文件**: `components/editor.tsx`, `components/excalidraw-canvas.tsx`, `actions/canvas-bindings.ts`

---

## � 待实现模块

### 5. 复合节点管理 (Next)
**优先级：高**
- 多选元素创建“组”概念。
- 逻辑组整体移动、缩放。
- 在数据库中维护 `compoundNodeId` 树形结构。

### 6. 文档-画布双向绑定引擎
**优先级：最高**
- 点击文档对应的 Block，画布自动聚焦/高亮对应元素。
- 反向联动：点击画布元素，文档滚动到对应段落。
- 状态同步：文档内容修改，画布元素实时感知并更新。

### 7. 实时协作与冲突解决
**优先级：中**
- Yjs/CRDT 深度集成。
- 多人协作光标共享。

### 8. 语义图谱增强
**优先级：中**
- 基于画布结构的语义搜索。
- AI 自动发现并建议新的文档绑定关系。

### 9. UI/UX 优化（80%）
- ✅ **画布展开动画优化**：画布放大时向左边扩展，而非向右（保持编辑器位置稳定）。
- ✅ **保存状态指示器**：左上角控制区实时反馈“已保存/保存中/变更中”，消除用户焦虑。
- **大纲视图功能**：类似 Notion 的文档大纲，支持快速导航和层级展示。
- **节点查询功能增强**：评估是否需要优化语义节点的搜索和过滤能力。

### 10. 数据导入导出
**优先级：中**
- **Notion 集成**：支持导入 Notion 笔记，支持导出到 Notion。
- **标准格式支持**：Markdown、PDF、HTML 等格式的导出。
- **批量操作**：支持批量导出多个文档。

### 11. 性能优化
**优先级：高**
- **三级缓存架构**：
  - L1: 内存缓存（React state/context）
  - L2: 本地存储（IndexedDB/LocalStorage）
  - L3: 远程数据库（PostgreSQL）
- **本地优先加载**：优先从本地缓存加载，提升打开速度。
- **增量同步**：只同步变更的数据，减少网络传输。

### 12. 项目可见性
**优先级：中**
- **更新日志系统**：Git 提交记录自动生成项目更新日记。
- **版本历史展示**：在应用内展示项目的迭代历史和新功能。
- **用户反馈渠道**：收集用户反馈和功能建议。

---

## 📈 进度统计
- **核心架构**: 100%
- **存储系统**: 100%
- **交互系统**: 95% (复合节点待增强)
- **同步系统**: 100% (双向联动已闭环)

**完成日期**: 2026-01-12

---

## 🎯 下一步建议

### 即将实现（按优先级排序）
1. **画布展开动画修正**：向左扩展而非向右，保持编辑器稳定。
2. **文档大纲功能**：Notion 风格的层级大纲视图，快速导航。
3. **三级缓存架构**：本地优先加载，显著提升打开速度。
4. **双向锚点跳转**：文档 ↔ 画布元素双向导航。
5. **复合节点管理**：Excalidraw Group 功能与数据库持久化。
6. **Notion 导入导出**：与 Notion 互通，方便数据迁移。
7. **项目更新日志**：自动化 Git 提交记录展示。

### 待评估
- **节点查询优化**：根据实际使用情况决定是否需要增强搜索功能。
